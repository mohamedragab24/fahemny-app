rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuth() {
      return request.auth != null;
    }
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    function isAdmin() {
      return get(/databases/$(database)/documents/userProfiles/$(request.auth.uid)).data.isAdmin == true;
    }

    // User Profiles
    // - Anyone can create their own profile (on signup).
    // - Users can read any profile (to see tutor/student names).
    // - Users can only update their own profile.
    // - Admins can update any profile (to disable or make admin).
    match /userProfiles/{userId} {
      allow create: if isAuth() && isOwner(userId);
      allow get: if isAuth();
      allow list: if isAuth() && isAdmin();
      allow update: if isAuth() && (isOwner(userId) || isAdmin());
      allow delete: if false; // Do not allow user profile deletion
    }

    // Session Requests
    // - Students can create requests for themselves.
    // - Anyone authenticated can read/list requests (for tutors to browse).
    // - Only the involved student or tutor, or an admin, can update a request.
    match /sessionRequests/{requestId} {
      allow create: if isAuth() && request.resource.data.studentId == request.auth.uid;
      allow read: if isAuth();
      // List is implicitly allowed by the read rule, queries must be specific.
      allow list: if isAuth();
      allow update: if isAuth() && (
        isOwner(resource.data.studentId) || 
        (resource.data.tutorId != null && isOwner(resource.data.tutorId)) ||
        isAdmin()
      );
      allow delete: if false;
    }
    
    // Transactions
    // - System (via client) creates transactions. User can only create for themselves.
    // - Users can only read their own transactions.
    // - Admins can read/list all transactions.
    match /transactions/{transactionId} {
      allow create: if isAuth() && isOwner(request.resource.data.userId);
      // Read is for a single document, list is for collections.
      // List query must be constrained by 'userId' in the client code.
      allow read: if isAuth() && (isOwner(resource.data.userId) || isAdmin());
      allow list: if isAuth() && isAdmin();
      allow update, delete: if false; // Transactions are immutable
    }

    // Notifications
    // - System (via client) creates notifications. Must be for the recipient.
    // - Users can read, update (mark as read), and delete their own notifications.
    match /notifications/{notificationId} {
       allow create: if isAuth() && isOwner(request.resource.data.userId);
       allow read, update, delete: if isAuth() && isOwner(resource.data.userId);
       // The client query must filter by userId, which is enforced by the `read` rule above.
       allow list: if isAuth();
    }
  }
}
