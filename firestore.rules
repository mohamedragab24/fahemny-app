rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    
    // SAFE for all rules, including list queries.
    function isAuth() {
      return request.auth != null;
    }
    // SAFE for all rules.
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // --- Helper Functions (UNSAFE FOR LIST QUERIES) ---
    // These functions use get() or exists() and should only be used in rules for
    // single-document operations (get, create, update, delete). They will cause
    // errors if used in rules that secure list/query operations.
    function getProfile(uid) {
      return get(/databases/$(database)/documents/userProfiles/$(uid)).data;
    }
    function profileExists(uid) {
      return exists(/databases/$(database)/documents/userProfiles/$(uid));
    }
    function isRole(uid, role) {
      return profileExists(uid) && getProfile(uid).role == role;
    }
    function isAdmin(uid) {
      // Use "== true" to handle cases where the field might not exist.
      return profileExists(uid) && getProfile(uid).isAdmin == true;
    }
    function isActive(uid) {
      // Use "!= true" to handle cases where the field might not exist (defaulting to active).
      return profileExists(uid) && getProfile(uid).disabled != true;
    }

    // --- Collection Rules ---

    match /userProfiles/{userId} {
      // Read: Any authenticated, active user can read any profile. 
      // This is safe for queries because isActive() checks the requester's own profile once.
      allow read: if isAuth() && isActive(request.auth.uid);
      
      // Create: A user can create their own profile.
      allow create: if isOwner(userId);
      
      // Update: A user can update their own profile, or an admin can update any profile.
      // Safe because update is a single-doc operation.
      allow update: if isAuth() && isActive(request.auth.uid) && (isOwner(userId) || isAdmin(request.auth.uid));
      
      // Delete: No one can delete profiles.
      allow delete: if false;
    }

    match /sessionRequests/{requestId} {
      // Read: This is a "clean" rule for queries. It has no get/exists calls.
      // It allows reading a session if you are the student, the assigned tutor, or if it's an open request.
      allow read: if isAuth() && (
        isOwner(resource.data.studentId) || 
        (resource.data.tutorId != null && isOwner(resource.data.tutorId)) ||
        resource.data.status == 'open'
      );

      // Create: An active student can create a request for themselves.
      // Safe because create is a single-doc operation.
      allow create: if isAuth() && isOwner(request.resource.data.studentId) && isRole(request.auth.uid, 'student') && isActive(request.auth.uid);
      
      // Update: Complex logic using unsafe helpers, which is fine for single-doc 'update'.
      allow update: if isAuth() && isActive(request.auth.uid) && (
        (isRole(request.auth.uid, 'tutor') && resource.data.status == 'open' && request.resource.data.status == 'accepted' && request.resource.data.tutorId == request.auth.uid) ||
        (isOwner(resource.data.studentId) && (resource.data.status == 'open' || resource.data.status == 'accepted') && request.resource.data.status == 'cancelled') ||
        ((isOwner(resource.data.studentId) || isOwner(resource.data.tutorId)) && resource.data.status == 'accepted' && request.resource.data.status == 'completed') ||
        (isOwner(resource.data.studentId) && resource.data.status == 'completed' && resource.data.tutorRating == null && request.resource.data.tutorRating != null) ||
        (isOwner(resource.data.tutorId) && resource.data.status == 'completed' && resource.data.studentRating == null && request.resource.data.studentRating != null) ||
        isAdmin(request.auth.uid)
      );
      
      // Delete: Student can delete their own 'open' request, or admin can delete any.
      allow delete: if isAuth() && ((isOwner(resource.data.studentId) && resource.data.status == 'open') || isAdmin(request.auth.uid));
    }

    match /transactions/{transactionId} {
      // Read: A user can read their own transactions. This "clean" rule is safe for queries.
      allow read: if isAuth() && isOwner(resource.data.userId);

      // Create: A user can create their own transaction.
      allow create: if isAuth() && isOwner(request.resource.data.userId);

      // No updates or deletes allowed.
      allow update, delete: if false;
    }

    match /notifications/{notificationId} {
      // Read/Update: A user can read/update their own notifications. This "clean" rule is safe for queries.
      allow read, update: if isAuth() && isOwner(resource.data.userId);
      
      // Create: Any authenticated user can create a notification (e.g. system, or tutor for student).
      allow create: if isAuth(); 
      
      // Delete: Not allowed.
      allow delete: if false;
    }
  }
}
